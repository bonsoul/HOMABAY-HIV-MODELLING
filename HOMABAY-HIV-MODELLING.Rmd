---
title: "Homabay - HIV/AIDS Modelling"
author: "Bonsoul"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r,libararies}
library(ggplot2)
library(tidyverse)
library(plotly)
library(rlang)
library(psych)
library(knitr)
library(stringr)
library(questionr)
library(gtsummary)
library(shiny)
library(lubridate)
library(magrittr)
library(expss)
library(rnaturalearth)
library(rnaturalearthdata)
library(CARBayes)
library(gridExtra)             
library(grid) 
library(survival)
library(caret) 
library(randomForest) 
library(dplyr) 
library(corrplot) 
library(readxl) 
library(tidyr) 
library(survminer) 
library(sf) 
library(tmap)
library(RColorBrewer)
library(kableExtra)
library(broom)
library(spdep)
library(brglm2)
```

```{r,reading data}
df = read_excel("D:/Downloads/HIV - VARIABLES.xlsx")
View(df)
```


```{r,EDA}
#Rename coordinate columns for clarity
df1 <- df %>% rename(latitude = var52, longitude = var51)

duplicates <- df1[duplicated(df1),] #checking duplicates
print(duplicates)


missing_per_column <- colSums(is.na(df1)) #columns with null values
total_missing <- sum(missing_per_column) 
print(total_missing) 
print(missing_per_column)

columns_with_missing <- names(missing_per_column[missing_per_column > 0]) 
print(columns_with_missing)
```
```{r Summary statistics for numerical variables }
#Compute summary statistics for numeric columns
summary_stats <- df1 %>% 
  select_if(is.numeric) %>% 
  summarise(across(
    everything(), 
    list(
      min = ~min(., na.rm = TRUE),
      Q1 = ~quantile(., 0.25, na.rm = TRUE),
      median = ~median(., na.rm = TRUE),
      mean = ~mean(., na.rm = TRUE),
      Q3 = ~quantile(., 0.75, na.rm = TRUE),
      max = ~max(., na.rm = TRUE),
      sd = ~sd(., na.rm = TRUE)
    )
  ))
summary(summary_stats)
```

```{r  Frequency distribution for categorical variables}
categorical_vars <- df1 %>%
  select_if(is.character)

for (var in names(categorical_vars)) {
  print(var)
  print(table(categorical_vars[[var]]))
}
```

```{r,hitograms}
#Visualize distributions with histograms

ggplot(df1, aes(x = age)) + 
  geom_histogram(binwidth = 5, fill = "blue", alpha = 0.7) + 
  ggtitle("Histogram of Age") + 
  theme_minimal()
  
  
ggplot(df1, aes(x = weightkg)) + 
  geom_histogram(binwidth = 5, fill = "blue", alpha = 0.7) + 
  ggtitle("Histogram of weightkg") + 
  theme_minimal()
  

ggplot(df1, aes(x = durationofbfmonths)) + 
  geom_histogram(binwidth = 5, fill = "blue", alpha = 0.7) + 
  ggtitle("Histogram of durationofbfmonths") + 
  theme_minimal()
```


```{r,boxplots}
# Define numeric variables for boxplots
numeric_vars <- c("age", "weightkg", "bwtkgs", "babywt6wks", "time", "_t")

# Create boxplots for each numeric variable
for (var in numeric_vars) {
  p <- ggplot(df1, aes(x = monthsantibodytest, y = .data[[var]], fill = monthsantibodytest)) +
    geom_boxplot() +
    labs(title = paste("Boxplot of", var, "by Months Antibody Test"),
         x = "Months Antibody Test",
         y = var) +
    theme_minimal()
  
  print(p)
}
```

```{r,gender distribution}
# Create a bar chart for gender distribution
gender_plot <- ggplot(df1, aes(x = sexofthebaby, fill = sexofthebaby)) +
  geom_bar() +
  labs(title = "Gender Distribution",
       x = "Gender",
       y = "Count") +
  theme_minimal()

print(gender_plot)
```
```{r,density plots}
# Create density plots
for (var in numeric_vars) {
  density_plot <- ggplot(df1, aes(x = .data[[var]], color = monthsantibodytest)) +
    geom_density() +
    labs(title = paste("Density Plot of", var), x = var, y = "Density") +
    theme_minimal()
  
  print(density_plot)
}
```

```{r,Mutating +ve and -ne to be numerical}
df2 <- df1 %>% mutate(monthsantibodytest = ifelse(tolower(monthsantibodytest) == "positive", 1, 0))

table(df1$monthsantibodytest)
```

### socio demo characteristic of parents

```{r franc1,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(subcounty, maritalstatus, residence, employmentstatus, educationlevel, monthsantibodytest) %>%
  tbl_summary(by = monthsantibodytest) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()

```

### ANC attendance of mothers


### ANC attendance of mothers
```{r franc2,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(ancattendance, facilitylevelanc, distancetofacility, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    type = everything() ~ "categorical"
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()
```



### gestation age at first anc visits wks

```{r franc3,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(gestationatfirstancwks, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    type = gestationatfirstancwks ~ "continuous2",
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()

```

### hiv status before pregnancy and syphillis

```{r franc4,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(hivstatusbeforepregnancy, syphillis, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()

```

### uti, miscarriage

```{r franc5,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(uti, miscarriage, abortion, stillbirth, premature, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()

```

### HIV and CD4

```{r franc6,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(haartduringpregnancy, cd4cellcountcellsmm3, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()

```

### mother history of having sexually transmitted disease during pregnancy

```{r franc7,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(historyofstiduringpregnancy, genitalwart, vaginaldischargesyndrome, genitalherpes, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()

```

### treatedduringpregnancy

```{r franc8,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(treatedduringpregnancy, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()

```

### malaria, anaemia, hypertention

```{r franc9,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(malaria, anaemia, hypertention, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()
```

### numberofchildren

```{r franc10,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(numberofchildren, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    type = numberofchildren ~ "categorical",
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()

```

### patnershivstatus, whohivdiseasestage

```{r franc12,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(patnershivstatus, whohivdiseasestage, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()

```

### numberofancvisitsmade

```{r franc13,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr::select(numberofancvisitsmade, monthsantibodytest) %>%
  tbl_summary(
    by=monthsantibodytest,
    type = numberofancvisitsmade ~ "categorical",
    statistic = list(all_categorical() ~ "{p}% ({n}/{N})",
                  all_dichotomous() ~ "{p}% ({n}/{N})",
                     all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})"))
   ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()
```

### hemoglobinlevelduringpregnancy

```{r franc14,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr:: select(hemoglobinlevelduringpregnancy, monthsantibodytest) %>%
  tbl_summary(
    by=monthsantibodytest,
    type = hemoglobinlevelduringpregnancy ~ "continuous2",
    statistic = list(all_categorical() ~ "{p}% ({n}/{N})",
                  all_dichotomous() ~ "{p}% ({n}/{N})",
                     all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})"))
   ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()
```

### durationofbfmonths

```{r franc15,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr:: select(lduration,durationofbfmonths, monthsantibodytest) %>%
  tbl_summary(
    by=monthsantibodytest,
    type = durationofbfmonths ~ "continuous2",
    statistic = list(all_categorical() ~ "{p}% ({n}/{N})",
                  all_dichotomous() ~ "{p}% ({n}/{N})",
                     all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})"))
   ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()
```

### sexofthebaby

```{r franc16,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr:: select(sexofthebaby, monthsantibodytest) %>%
  tbl_summary(
    by=monthsantibodytest,
   # type = durationofbfmonths ~ "continuous2",
    statistic = list(all_categorical() ~ "{p}% ({n}/{N})",
                  all_dichotomous() ~ "{p}% ({n}/{N})",
                     all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})"))
   ) %>%
  add_overall() %>%
  add_p() %>%
  bold_labels()
```

#subcounty

```{r franc17,echo=FALSE, message=FALSE, warning=FALSE, include=T}
df2 %>%
  dplyr:: select(subcounty, monthsantibodytest) %>%
  tbl_summary(
    by = monthsantibodytest,  # Grouping by monthsantibodytest
    statistic = list(
      all_categorical() ~ "{p}% ({n}/{N})",
      all_dichotomous() ~ "{p}% ({n}/{N})",
      all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})")
    )
  ) %>%
  add_overall() %>%  # Now valid because `by` is specified
  add_p() %>%
  bold_labels()

```

### PCR test trend

```{r franc17,echo=FALSE, message=FALSE, warning=FALSE, include=T}
data_fr %>%
  select(birthpcr,weekspcr, monthspcr,yearpcr,monthsantibodytest) %>%
  tbl_summary(
   # by=monthsantibodytest,
   # type = durationofbfmonths ~ "continuous2",
    statistic = list(all_categorical() ~ "{p}% ({n}/{N})",
                  all_dichotomous() ~ "{p}% ({n}/{N})",
                     all_continuous2() ~ c("{median} ({min} - {max})", "{mean} ({sd})"))
   ) %>%
  #add_overall() %>%
 # add_p() %>%
  bold_labels()
```


```{r, pvalue}
# Define dependent variable
dependent_var <- "monthsantibodytest"

# Define categorical variables
categorical_vars <- c(
  "subcounty", "maritalstatus", "historyofstiduringpregnancy", "hypertension", 
  "partnershivstatus", "whohivdiseasestage", "t_membrane_r", "sexofthebaby", 
  "residence", "syphillis", "cd4cellcountcellsmm3", "employmentstatus", 
  "ancattendance", "facilitylevelanc", "hivstatusbeforepregnancy", "syphilis", 
  "uti", "miscarriage", "abortion", "stillbirth", "premature", 
  "haartduringpregnancy", "cd4cellcount", "historysti_during_pregnancy", "distancetofacility",
  "genitalwart", "vaginaldischargesyndrome", "genitalherpes", 
  "treatedduringpregnancy", "malaria", "anaemia", "hypertension", 
  "partnerhivstatus", "whohivdiseasestage", "t_membrane_r", "sexbaby", 
  "educationlevel", "adherence","tmembraner", "hypertention","patnershivstatus"
)

# Filter only variables that exist in df1
all_vars <- categorical_vars[categorical_vars %in% names(df2)]

# Perform chi-square tests
chi_results <- lapply(all_vars, function(var) {
  table_data <- table(df1[[var]], df2[[dependent_var]])
  test <- chisq.test(table_data)
  data.frame(variable = var, chi2_value = test$statistic, p_value = test$p.value)
})

# Combine results into a data frame
chi_result_df <- do.call(rbind, chi_results)

# Display results in an HTML table
kable(chi_result_df, format = "html", digits = 4, caption = "Table 1: Chi-square Test Results for HIV Antigen Positivity") %>%
  kable_styling(full_width = FALSE, position = "left", font_size = 14) %>%
  column_spec(1, bold = TRUE) %>%   
  column_spec(2, width = "5cm") %>% 
  column_spec(3, width = "5cm") %>% 
  footnote(general = "Source: Computed results based on chi-square test.")
```

```{r,bivariate}
# Define dependent variable
dependent_var <- "monthsantibodytest"  

# List of independent variables for bivariate logistic regression
independent_vars <- c(
  "ancattendance", "haartduringpregnancy", "whohivdiseasestage", "numberofancvisitsmade",
  "lduration", "durationofbfmonths", "educationlevel", "adherence",
  "hivstatusbeforepregnancy", "premature"
) 

# Filter variables that exist in df1
available_vars <- independent_vars[independent_vars %in% names(df2)]

# Function to perform bivariate logistic regression
logit_results <- lapply(available_vars, function(var) {
  formula <- as.formula(paste(dependent_var, "~", var))
  
  # Handle potential errors in model fitting
  result <- tryCatch({
    model <- glm(formula, data = df2, family = binomial)
    tidy_model <- tidy(model, conf.int = TRUE)  # Get summary with confidence intervals
    
    # Format output
    data.frame(
      Variable = var,
      Odds_Ratio = round(exp(tidy_model$estimate[2]), 4),  # Exponentiate coefficient
      CI_Low = round(exp(tidy_model$conf.low[2]), 3),
      CI_High = round(exp(tidy_model$conf.high[2]), 3),
      P_Value = round(tidy_model$p.value[2], 4)
    )
  }, error = function(e) {
    # If error occurs, return NA values
    data.frame(
      Variable = var, Odds_Ratio = NA, CI_Low = NA, CI_High = NA, P_Value = NA
    )
  })
  
  return(result)
})

# Combine results into a data frame
bivar_logit_results_df <- do.call(rbind, logit_results) %>%
  as_tibble() %>%  
  mutate(CI = paste0("[", CI_Low, "-", CI_High, "]")) %>%
  dplyr::select(Variable, Odds_Ratio, CI, P_Value)
  #select(Variable, Odds_Ratio, CI, P_Value) 

# Display results in an HTML table
kable(bivar_logit_results_df, format = "html", digits = 4, 
      caption = "Table 4.2: Factors Associated with HIV Antigen Positivity by Bivariate Logistic Regression") %>%
  kable_styling(full_width = FALSE, position = "left", font_size = 14) %>%
  column_spec(1, bold = TRUE) %>%   
  column_spec(2, width = "5cm") %>% 
  column_spec(3, width = "5cm") %>% 
  column_spec(4, width = "5cm") %>% 
  footnote(general = "Source: Computed results based on bivariate logistic regression.")
```

